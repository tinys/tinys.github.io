<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta content="yes" name="apple-mobile-web-app-capable"/>
		<meta content="yes" name="apple-touch-fullscreen"/>
		<meta content="telephone=no" name="format-detection"/>
		<meta content="black" name="apple-mobile-web-app-status-bar-style">
		<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" />
		<title>有种在风里听歌的感觉</title>
		
	</head>
	<body>
		<audio id="audio" controls="controls" autoplay="autoplay">
		  <source src="./jiazaidongbei.mp3" type="audio/mpeg">
			Your browser does not support the audio tag.
		</audio>
		<canvas width="600" height="300" id="canvas" style="display:block;border:1px solid #666">
			Your browser does not support the canvas tag.
		</canvas>
		<div id="message"></div>
		<script type="text/javascript">
			var win = window;
			var rAF = win.requestAnimationFrame	||
				win.webkitRequestAnimationFrame	||
				window.mozRequestAnimationFrame		||
				window.oRequestAnimationFrame		||
				win.msRequestAnimationFrame		||
				function (callback) { win.setTimeout(callback, 1000 / 60); };
			
			function Wave(option){
				this.start = Date.now();
				var opt = {
					// 传播速度 ms
					rate:300
				}
				if(option){
					["maxValue","rate"].forEach(function(a){
						option[a]!== undefined && (opt[a] = option[a]);
					})
				}
				this.option = opt;
			}
			// 获得现在的值
			Wave.prototype.getValue = function(){
				var _this = this;
				_this.runTime = (Date.now() - this.start)/ _this.option.rate;
				_this.lastValue = Math.cos(_this.runTime);
				return _this.lastValue;
			}
			Wave.prototype.getLastValue = function(){
				return {
					time:this.runTime,
					value:this.lastValue
				}
			}
			function DrawPoint(canvas){
				this.canvas = canvas;
				this.context = canvas.getContext("2d");
				this.startX = 0;
				this.startY = canvas.height/2;
				this.lastX =0;
				this.lastY = this.startY;
				this.width = canvas.width;
			}
			DrawPoint.prototype.drawPoint = function(x,y){
				var _this = this,
				tx = _this.startX +x;
				ty = _this.startY - y;
				
				if(tx > _this.width){
					_this.rect(50,function(){
						_this.drawPoint(x,y);
					})
					return;
				}
				
				var context = _this.context;
				context.beginPath();
				context.moveTo(_this.lastX,_this.lastY);
				context.lineTo(tx,ty);
				_this.lastX = tx;
				_this.lastY = ty;
				context.stroke();
				context.closePath();
			}
			DrawPoint.prototype.rect = function(x,cb){
				var _this = this;
				var context = _this.context;
				var img = new Image();
				img.src = _this.canvas.toDataURL();
				
				context.clearRect(0,0,_this.width,_this.canvas.height);
				// drawImage(image, sourceX, sourceY, sourceWidth, sourceHeight,destX, destY, destWidth, destHeight)
				context.drawImage(img,x,0,_this.width -x,_this.canvas.height,0,0,_this.width -x,_this.canvas.height);
				_this.startX -= x;
				_this.lastX -=x;
				cb && cb();
			}
			
			function E(query,parent){
				var p = parent || document;
				return p.querySelector(query);
			}
			audio = E("audio");
			var count = 1,wave = false,isStop = false,canvas;
			function startLoopVoice(){
				if(isStop){
					return;
				}
				var value = Math.max(Math.abs(wave.getValue()),.3);
				audio.volume = value;
				canvas.drawPoint(wave.getLastValue().time * 40,value * 100);
				rAF(startLoopVoice);
			}
			audio.onprogress=function(){
				if(!wave){
					wave = new Wave({
						rate:800
					});
					canvas = new DrawPoint(E("canvas"));
					isStop = false;
					startLoopVoice();
				}
			}
			audio.onended = function(){
				isStop = true;
			}
		</script>
	</body>
</html>